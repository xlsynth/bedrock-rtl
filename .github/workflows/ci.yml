name: CI
on:
  push:
    branches:
      - main
  pull_request:
    types: [opened, reopened, synchronize]

jobs:
  # Run the cheapest checks first.
  # 1. pre-commit
  # 2. bazel
  #    a. build
  #    b. tests
  #
  # Run bazel build before bazel tests because the logging is not chronologically
  # ordered if a build step fails while unrelated tests are running.
  pre-commit:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-python@v3
      - uses: pre-commit/action@v3.0.1

  bazel-build:
    runs-on: self-hosted
    steps:
    - name: Checkout repo
      uses: actions/checkout@v3
    - name: Copy ci.bazelrc
      working-directory: ${{ github.workspace }}
      run: cp /home/gh-actions/bedrock-infra/ci.bazelrc ci.bazelrc
    - name: Build
      run: bazel build --noshow_loading_progress //...

  bazel-test-python:
    runs-on: self-hosted
    needs: bazel-build
    steps:
    - name: Python tests
      run: bazel test --noshow_loading_progress //python/...

  bazel-test-stardoc:
    runs-on: self-hosted
    needs: bazel-build
    steps:
    - name: Stardoc tests
      run: bazel test --noshow_loading_progress //bazel/...

  bazel-test-verific:
    runs-on: self-hosted
    needs: bazel-build
    steps:
    - name: Verilog elab tests (using Verific)
      # Suppress log output to protect sensitive EDA tool information.
      run: bazel test --noshow_loading_progress //... --test_tag_filters=verific --test_output=summary

  bazel-test-ascentlint:
    runs-on: self-hosted
    # AscentLint licenses are fairly limited, and the RTL lint tests cannot
    # pass if the separate Verific elaboration tests don't pass.
    # Put this dependency to avoid wasting lint license checkouts.
    needs: bazel-test-verific
    steps:
    - name: Verilog lint tests (using AscentLint)
      # Suppress log output to protect sensitive EDA tool information.
      run: bazel test --noshow_loading_progress //... --test_tag_filters=ascentlint --test_output=summary

  bazel-test-dsim:
    runs-on: self-hosted
    needs: bazel-build
    outputs:
      dsim_num_tests: ${{ steps.test.outputs.dsim_num_tests }}
      dsim_num_passing_tests: ${{ steps.test.outputs.dsim_num_passing_tests }}
      result: ${{ job.status }}
    steps:
    - name: Verilog sim tests (using dsim)
      id: test
      continue-on-error: true
      # Suppress log output to protect sensitive EDA tool information.
      run: |
        bazel test --test_output=streamed //... --test_tag_filters=dsim 2>&1 | tee .bazel-test-dsim.log
        DSIM_NUM_TESTS=$(grep -Po '(?<=out of )\d+(?= tests)' .bazel-test-dsim.log)
        DSIM_NUM_PASSING_TESTS=$(grep -Po '\d+(?= tests pass)' .bazel-test-dsim.log)
        echo "dsim_num_tests=$DSIM_NUM_TESTS" >> $GITHUB_OUTPUT
        echo "dsim_num_passing_tests=$DSIM_NUM_PASSING_TESTS" >> $GITHUB_OUTPUT

  bazel-test-dsim-badge:
    runs-on: ubuntu-latest
    needs: bazel-test-dsim
    if: always()
    # FIXME
    #if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
    steps:
    - name: Create dsim badge
      uses: schneegans/dynamic-badges-action@v1.7.0
      with:
        auth: ${{ secrets.MGOTTSCHO_GISTS_SECRET }}
        gistID: 643181481f2cee698ca0b69f25667cd0
        filename: bedrock-rtl-ci-dsim.json
        label: "dsim"
        message: ${{ needs.bazel-test-dsim.outputs.dsim_num_passing_tests }} of ${{ needs.bazel-test-dsim.outputs.dsim_num_tests }} passing
        # Default color; if isError is true, it will get automatically overridden to red.
        color: 'green'
        isError: ${{ needs.bazel-test-dsim.result != 'success' }}

  bazel-test-vcs:
    runs-on: self-hosted
    needs: bazel-build
    steps:
    - name: Verilog sim tests (using vcs)
      # Suppress log output to protect sensitive EDA tool information.
      run: bazel test --noshow_loading_progress //... --test_tag_filters=vcs --test_output=summary

  bazel-test-iverilog:
    runs-on: self-hosted
    needs: bazel-build
    steps:
    - name: Verilog sim tests (using iverilog)
      run: bazel test --noshow_loading_progress //... --test_tag_filters=iverilog

    # TODO: VCF tests
    # TODO: JG tests
