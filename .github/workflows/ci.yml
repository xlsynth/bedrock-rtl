name: CI
on:
  push:
    branches:
      - main
  pull_request:
    types: [opened, reopened, synchronize]

jobs:
  # Run the cheapest checks first.
  # 1. pre-commit
  # 2. bazel
  #    a. build
  #    b. tests
  #
  # Run bazel build before bazel tests because the logging is not chronologically
  # ordered if a build step fails while unrelated tests are running.
  pre-commit:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-python@v3
      - uses: pre-commit/action@v3.0.1

  bazel-build:
    runs-on: self-hosted
    steps:
    - name: Checkout repo
      uses: actions/checkout@v3
    - name: Copy ci.bazelrc
      working-directory: ${{ github.workspace }}
      run: cp /home/gh-actions/bedrock-infra/ci.bazelrc ci.bazelrc
    - name: Build
      run: bazel build --noshow_loading_progress //...

  bazel-test-python:
    runs-on: self-hosted
    needs: bazel-build
    steps:
    - name: Python tests
      run: bazel test --noshow_loading_progress //python/...

  bazel-test-stardoc:
    runs-on: self-hosted
    needs: bazel-build
    steps:
    - name: Stardoc tests
      run: bazel test --noshow_loading_progress //bazel/...

  bazel-test-verific:
    runs-on: self-hosted
    needs: bazel-build
    steps:
    - name: Verilog elab tests (using Verific)
      # Suppress log output to protect sensitive EDA tool information.
      run: bazel test --noshow_loading_progress //... --test_tag_filters=verific --test_output=summary

  bazel-test-ascentlint:
    runs-on: self-hosted
    # AscentLint licenses are fairly limited, and the RTL lint tests cannot
    # pass if the separate Verific elaboration tests don't pass.
    # Put this dependency to avoid wasting lint license checkouts.
    needs: bazel-test-verific
    steps:
    - name: Verilog lint tests (using AscentLint)
      # Suppress log output to protect sensitive EDA tool information.
      run: bazel test --noshow_loading_progress //... --test_tag_filters=ascentlint --test_output=summary

  bazel-test-dsim:
    runs-on: self-hosted
    needs: bazel-build
    steps:
    - name: Verilog sim tests (using dsim)
      # Suppress log output to protect sensitive EDA tool information.
      run: bazel test --noshow_loading_progress //... --test_tag_filters=dsim --test_output=summary

  bazel-test-vcs:
    runs-on: self-hosted
    needs: bazel-build
    steps:
    - name: Verilog sim tests (using vcs)
      # Suppress log output to protect sensitive EDA tool information.
      run: bazel test --noshow_loading_progress //... --test_tag_filters=vcs --test_output=summary

    # TODO: iverilog tests
  bazel-test-iverilog:
    runs-on: self-hosted
    needs: bazel-build
    steps:
    - name: Verilog sim tests (using iverilog)
      run: bazel test --noshow_loading_progress //... --test_tag_filters=iverilog

    # TODO: VCF tests
    # TODO: JG tests
