name: CI
on:
  push:
    branches:
      - main
  pull_request:
    types: [opened, reopened, synchronize]
  # Allow manual triggers
  workflow_dispatch: {}

# Only allow one pipeline to run at a time.
concurrency:
  group: ${{ github.repository }}
  cancel-in-progress: false

jobs:
  pre-commit:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-python@v3
      - uses: pre-commit/action@v3.0.1

  # Run bazel build and tests in order in one job to avoid parallel jobs that make
  # build logs appear out of sequence across the CI workflow.
  bazel-build-and-test:
    runs-on: self-hosted
    outputs:
      python_total_tests: ${{ steps.python.outputs.total_tests }}
      python_passing_tests: ${{ steps.python.outputs.passing_tests }}
      python_exit_code: ${{ steps.python.outputs.exit_code }}
      stardoc_total_tests: ${{ steps.stardoc.outputs.total_tests }}
      stardoc_passing_tests: ${{ steps.stardoc.outputs.passing_tests }}
      stardoc_exit_code: ${{ steps.stardoc.outputs.exit_code }}
      verific_total_tests: ${{ steps.verific.outputs.total_tests }}
      verific_passing_tests: ${{ steps.verific.outputs.passing_tests }}
      verific_exit_code: ${{ steps.verific.outputs.exit_code }}
      ascentlint_total_tests: ${{ steps.ascentlint.outputs.total_tests }}
      ascentlint_passing_tests: ${{ steps.ascentlint.outputs.passing_tests }}
      ascentlint_exit_code: ${{ steps.ascentlint.outputs.exit_code }}
      vcs_total_tests: ${{ steps.vcs.outputs.total_tests }}
      vcs_passing_tests: ${{ steps.vcs.outputs.passing_tests }}
      vcs_exit_code: ${{ steps.vcs.outputs.exit_code }}
      iverilog_total_tests: ${{ steps.iverilog.outputs.total_tests }}
      iverilog_passing_tests: ${{ steps.iverilog.outputs.passing_tests }}
      iverilog_exit_code: ${{ steps.iverilog.outputs.exit_code }}
    steps:
    - uses: actions/checkout@v3
    - name: Copy ci.bazelrc
      working-directory: ${{ github.workspace }}
      run: cp /home/gh-actions/bedrock-infra/ci.bazelrc ci.bazelrc
    - name: Build
      run: bazel build --noshow_loading_progress //...
    - name: python tests
      id: python
      run: |
        bazel test --noshow_loading_progress //python/... 2>&1 | tee .bazel-test-python.log
        BAZEL_EXIT_CODE=${PIPESTATUS[0]}
        TOTAL_TESTS=$(grep -Po '(?<=out of )\d+(?= test)' .bazel-test-python.log)
        PASSING_TESTS=$(grep -Po '\d+(?= test passes?\.| tests pass)' .bazel-test-python.log)
        echo "total_tests=$TOTAL_TESTS" >> $GITHUB_OUTPUT
        echo "passing_tests=$PASSING_TESTS" >> $GITHUB_OUTPUT
        echo "exit_code=$BAZEL_EXIT_CODE" >> $GITHUB_OUTPUT
        exit $BAZEL_EXIT_CODE
    - name: Stardoc tests
      id: stardoc
      run: |
        bazel test --noshow_loading_progress //bazel/... 2>&1 | tee .bazel-test-stardoc.log
        BAZEL_EXIT_CODE=${PIPESTATUS[0]}
        TOTAL_TESTS=$(grep -Po '(?<=out of )\d+(?= test)' .bazel-test-stardoc.log)
        PASSING_TESTS=$(grep -Po '\d+(?= test passes?\.| tests pass)' .bazel-test-stardoc.log)
        echo "total_tests=$TOTAL_TESTS" >> $GITHUB_OUTPUT
        echo "passing_tests=$PASSING_TESTS" >> $GITHUB_OUTPUT
        echo "exit_code=$BAZEL_EXIT_CODE" >> $GITHUB_OUTPUT
        exit $BAZEL_EXIT_CODE
    - name: Verilog elaboration tests (using Verific tclmain)
      id: verific
      # Use --test_output=summary to suppress log output, even on failure (proprietary EDA tool output may be sensitive).
      run: |
        bazel test --noshow_loading_progress --test_output=summary //... --test_tag_filters=verific 2>&1 | tee .bazel-test-verific.log
        BAZEL_EXIT_CODE=${PIPESTATUS[0]}
        TOTAL_TESTS=$(grep -Po '(?<=out of )\d+(?= test)' .bazel-test-verific.log)
        PASSING_TESTS=$(grep -Po '\d+(?= test passes?\.| tests pass)' .bazel-test-verific.log)
        echo "total_tests=$TOTAL_TESTS" >> $GITHUB_OUTPUT
        echo "passing_tests=$PASSING_TESTS" >> $GITHUB_OUTPUT
        echo "exit_code=$BAZEL_EXIT_CODE" >> $GITHUB_OUTPUT
        exit $BAZEL_EXIT_CODE
    # Keep AscentLint after Verific as before.
    - name: Verilog lint tests (using RealIntent AscentLint)
      id: ascentlint
      # Use --test_output=summary to suppress log output, even on failure (proprietary EDA tool output may be sensitive).
      run: |
        bazel test --noshow_loading_progress --test_output=summary //... --test_tag_filters=ascentlint 2>&1 | tee .bazel-test-ascentlint.log
        BAZEL_EXIT_CODE=${PIPESTATUS[0]}
        TOTAL_TESTS=$(grep -Po '(?<=out of )\d+(?= test)' .bazel-test-ascentlint.log)
        PASSING_TESTS=$(grep -Po '\d+(?= test passes?\.| tests pass)' .bazel-test-ascentlint.log)
        echo "total_tests=$TOTAL_TESTS" >> $GITHUB_OUTPUT
        echo "passing_tests=$PASSING_TESTS" >> $GITHUB_OUTPUT
        echo "exit_code=$BAZEL_EXIT_CODE" >> $GITHUB_OUTPUT
        exit $BAZEL_EXIT_CODE
    - name: Verilog sim tests (using Synopsys VCS)
      id: vcs
      # Use --test_output=summary to suppress log output, even on failure (proprietary EDA tool output may be sensitive).
      run: |
        bazel test --noshow_loading_progress --test_output=summary //... --test_tag_filters=vcs 2>&1 | tee .bazel-test-vcs.log
        BAZEL_EXIT_CODE=${PIPESTATUS[0]}
        TOTAL_TESTS=$(grep -Po '(?<=out of )\d+(?= test)' .bazel-test-vcs.log)
        PASSING_TESTS=$(grep -Po '\d+(?= test passes?\.| tests pass)' .bazel-test-vcs.log)
        echo "total_tests=$TOTAL_TESTS" >> $GITHUB_OUTPUT
        echo "passing_tests=$PASSING_TESTS" >> $GITHUB_OUTPUT
        echo "exit_code=$BAZEL_EXIT_CODE" >> $GITHUB_OUTPUT
        exit $BAZEL_EXIT_CODE
    - name: Verilog sim tests (using Icarus Verilog)
      id: iverilog
      # Don't need --test_output=summary to suppress log output because iverilog is open source.
      run: |
        bazel test --noshow_loading_progress //... --test_tag_filters=iverilog 2>&1 | tee .bazel-test-iverilog.log
        BAZEL_EXIT_CODE=${PIPESTATUS[0]}
        TOTAL_TESTS=$(grep -Po '(?<=out of )\d+(?= test)' .bazel-test-iverilog.log)
        PASSING_TESTS=$(grep -Po '\d+(?= test passes?\.| tests pass)' .bazel-test-iverilog.log)
        echo "total_tests=$TOTAL_TESTS" >> $GITHUB_OUTPUT
        echo "passing_tests=$PASSING_TESTS" >> $GITHUB_OUTPUT
        echo "exit_code=$BAZEL_EXIT_CODE" >> $GITHUB_OUTPUT
        exit $BAZEL_EXIT_CODE

  ##########################################
  ##########################################
  ##########################################
  #
  #                 BADGES
  #
  ##########################################
  ##########################################
  ##########################################
  rtl-files-badge:
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
    steps:
    - uses: actions/checkout@v3
    - name: Count RTL files
      run: |
        NUM_RTL_FILES=$(find . -type d -name rtl -exec find {} -type f -name "*.sv" \; | wc -l)
        echo "NUM_RTL_FILES=$NUM_RTL_FILES" >> $GITHUB_ENV
    - name: Create RTL files badge
      uses: schneegans/dynamic-badges-action@v1.7.0
      with:
        auth: ${{ secrets.MGOTTSCHO_GISTS_SECRET }}
        gistID: c66dc2ddc0e513ba06ce338620977b26
        filename: rtl.json
        label: "rtl files"
        message: ${{ env.NUM_RTL_FILES }}
        color: "purple"

  python-badge:
    runs-on: ubuntu-latest
    needs: bazel-build-and-test
    if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
    steps:
    - name: Create python badge
      uses: schneegans/dynamic-badges-action@v1.7.0
      with:
        auth: ${{ secrets.MGOTTSCHO_GISTS_SECRET }}
        gistID: c66dc2ddc0e513ba06ce338620977b26
        filename: python.json
        label: "python"
        message: ${{ needs.bazel-build-and-test.outputs.python_passing_tests }} of ${{ needs.bazel-build-and-test.outputs.python_total_tests }} passing
        color: ${{ needs.bazel-build-and-test.outputs.python_exit_code == '0' && 'brightgreen' || 'red' }}

  stardoc-badge:
    runs-on: ubuntu-latest
    needs: bazel-build-and-test
    if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
    steps:
    - name: Create stardoc badge
      uses: schneegans/dynamic-badges-action@v1.7.0
      with:
        auth: ${{ secrets.MGOTTSCHO_GISTS_SECRET }}
        gistID: c66dc2ddc0e513ba06ce338620977b26
        filename: stardoc.json
        label: "stardoc"
        message: ${{ needs.bazel-build-and-test.outputs.stardoc_passing_tests }} of ${{ needs.bazel-build-and-test.outputs.stardoc_total_tests }} passing
        color: ${{ needs.bazel-build-and-test.outputs.stardoc_exit_code == '0' && 'brightgreen' || 'red' }}

  verific-badge:
    runs-on: ubuntu-latest
    needs: bazel-build-and-test
    if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
    steps:
    - name: Create verific badge
      uses: schneegans/dynamic-badges-action@v1.7.0
      with:
        auth: ${{ secrets.MGOTTSCHO_GISTS_SECRET }}
        gistID: c66dc2ddc0e513ba06ce338620977b26
        filename: verific.json
        label: "verific"
        message: ${{ needs.bazel-build-and-test.outputs.verific_passing_tests }} of ${{ needs.bazel-build-and-test.outputs.verific_total_tests }} passing
        color: ${{ needs.bazel-build-and-test.outputs.verific_exit_code == '0' && 'brightgreen' || 'red' }}

  ascentlint-badge:
    runs-on: ubuntu-latest
    needs: bazel-build-and-test
    if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
    steps:
    - name: Create ascentlint badge
      uses: schneegans/dynamic-badges-action@v1.7.0
      with:
        auth: ${{ secrets.MGOTTSCHO_GISTS_SECRET }}
        gistID: c66dc2ddc0e513ba06ce338620977b26
        filename: ascentlint.json
        label: "ascentlint"
        message: ${{ needs.bazel-build-and-test.outputs.ascentlint_passing_tests }} of ${{ needs.bazel-build-and-test.outputs.ascentlint_total_tests }} passing
        color: ${{ needs.bazel-build-and-test.outputs.ascentlint_exit_code == '0' && 'brightgreen' || 'red' }}

  vcs-badge:
    runs-on: ubuntu-latest
    needs: bazel-build-and-test
    if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
    steps:
    - name: Create vcs badge
      uses: schneegans/dynamic-badges-action@v1.7.0
      with:
        auth: ${{ secrets.MGOTTSCHO_GISTS_SECRET }}
        gistID: c66dc2ddc0e513ba06ce338620977b26
        filename: vcs.json
        label: "vcs"
        message: ${{ needs.bazel-build-and-test.outputs.vcs_passing_tests }} of ${{ needs.bazel-build-and-test.outputs.vcs_total_tests }} passing
        color: ${{ needs.bazel-build-and-test.outputs.vcs_exit_code == '0' && 'brightgreen' || 'red' }}

  iverilog-badge:
    runs-on: ubuntu-latest
    needs: bazel-build-and-test
    if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
    steps:
    - name: Create iverilog badge
      uses: schneegans/dynamic-badges-action@v1.7.0
      with:
        auth: ${{ secrets.MGOTTSCHO_GISTS_SECRET }}
        gistID: c66dc2ddc0e513ba06ce338620977b26
        filename: iverilog.json
        label: "iverilog"
        message: ${{ needs.bazel-build-and-test.outputs.iverilog_passing_tests }} of ${{ needs.bazel-build-and-test.outputs.iverilog_total_tests }} passing
        color: ${{ needs.bazel-build-and-test.outputs.iverilog_exit_code == '0' && 'brightgreen' || 'red' }}
